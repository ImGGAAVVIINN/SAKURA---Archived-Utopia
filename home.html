<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home Page</title>
  <link rel="stylesheet" href="home.css" />
        <link rel="stylesheet" href="https://unpkg.com/7.css/dist/7.scoped.css" />
    <!-- GSAP Core -->
        <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
    <!-- GSAP Plugins -->
        <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/SplitText.min.js"></script>
    <!-- Lenis -->
    <script src="https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.35/dist/lenis.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
        <script>
            // Set manual scroll restoration early so the browser doesn't restore scroll on reload
            if ('scrollRestoration' in history) history.scrollRestoration = 'manual'
            // Quick defensive scroll to top as early as possible
            try { window.scrollTo(0,0) } catch (e) {}
            window.addEventListener('pageshow', (e) => { if (e.persisted) try { window.scrollTo(0,0) } catch (e) {} })
        </script>
</head>
<body class="has-scrollbar">
        <!-- White fade-in overlay -->
        <div id="page-fade-overlay"></div>
        
        <!-- Welcome Splash Screen -->
        <canvas id="welcome-splash" style="position: fixed; inset: 0; width: 100vw; height: 100vh; z-index: 9999;">
                Your browser does not support canvas.
        </canvas>
        <div id="glass-icons-container">
            <div class="glass-icon-top-row">
                <img id="glass-icon-start" src="images/icons/starthover.png" alt="" />
                <div class="glass-icon-right-stack">
                    <img id="glass-icon-horizon" src="images/Horizon-OS.png" alt="" />
                    <img id="glass-icon-version" src="images/1.0.png" alt="" />
                    <h1 style="font-family: 'Frutiger'; font-size: 1rem; margin-top: 0.1rem;">Common World Institute of Technology</h1>
                </div>
            </div>
            <div class="glass-icon-bottom-row">
                <img src="images/icons/internet.png" alt="" />
                <img src="images/icons/run-build-configure.svg" alt="" />
                <img src="images/icons/mouse.png" alt="" />
                <img src="images/icons/multiWindows.svg" alt="" />
                <img src="images/icons/laptop.png" alt="" />
                <img src="images/icons/seperation.png" alt="" />
                <img src="images/icons/system-software-update.svg" alt="" />
            </div>
            <div id="debugging" style="background-color: black; width: 28rem ;margin: auto; margin-top: 0.5rem; padding: 0.5rem; border-radius: 0.5rem;">
                
            </div>
        
        </div>
        <div id="welcome-progressbar" class="win7" style="position: fixed; left: 50%; bottom: 0; transform: translateX(-50%); width: calc(100vw + 32px); margin: 0; padding: 0; z-index: 10002; pointer-events: none;">
            <div role="progressbar" class="marquee" style="margin: 0; width: 100%; border-radius: 0;"></div>
        </div>
        </div>
        <img
                id="welcome-splash-image"
                src="images/welcomeBG.png"
                alt=""
        />

        <script id="welcome-splash-shader" type="x-shader/x-fragment">
            precision mediump float;

            uniform vec3 iResolution;
            uniform float iTime;
            uniform vec4 iMouse;
            uniform sampler2D iChannel0;

            void mainImage(out vec4 fragColor, in vec2 fragCoord)
            {
                const float NUM_ZERO = 0.0;
                const float NUM_ONE = 1.0;
                const float NUM_HALF = 0.5;
                const float NUM_TWO = 2.0;
                const float POWER_EXPONENT = 6.0;
                const float LENS_SIZE_SCALE = 1.2;
                const float LENS_WIDTH_PADDING = 0.1;
                const float MASK_MULTIPLIER_1 = 2500.0;
                const float MASK_MULTIPLIER_2 = 2300.0;
                const float MASK_MULTIPLIER_3 = 2700.0;
                const float LENS_MULTIPLIER = 1400.0;
                const float MASK_STRENGTH_1 = 8.0;
                const float MASK_STRENGTH_2 = 16.0;
                const float MASK_STRENGTH_3 = 2.0;
                const float MASK_THRESHOLD_1 = 0.95;
                const float MASK_THRESHOLD_2 = 0.9;
                const float MASK_THRESHOLD_3 = 1.5;
                const float SAMPLE_RANGE = 4.0;
                const float SAMPLE_OFFSET = 0.5;
                const float GRADIENT_RANGE = 0.2;
                const float GRADIENT_OFFSET = 0.1;
                const float GRADIENT_EXTREME = -1000.0;
                const float LIGHTING_INTENSITY = 0.3;

                vec2 uv = fragCoord / iResolution.xy;
                vec2 mouse = iMouse.xy;
                vec2 m2 = (uv - mouse / iResolution.xy);
                vec2 m2Scaled = m2 * LENS_SIZE_SCALE;

                float ax = abs(m2Scaled.x * iResolution.x / iResolution.y);
                float ay = abs(m2Scaled.y);
                float roundedBox = pow(max(NUM_ZERO, ax - LENS_WIDTH_PADDING), POWER_EXPONENT) + pow(ay, POWER_EXPONENT);
                float rb1 = clamp((NUM_ONE - roundedBox * MASK_MULTIPLIER_1) * MASK_STRENGTH_1, NUM_ZERO, NUM_ONE);
                float rb2 = clamp((MASK_THRESHOLD_1 - roundedBox * MASK_MULTIPLIER_2) * MASK_STRENGTH_2, NUM_ZERO, NUM_ONE) -
                    clamp(pow(MASK_THRESHOLD_2 - roundedBox * MASK_MULTIPLIER_2, NUM_ONE) * MASK_STRENGTH_2, NUM_ZERO, NUM_ONE);
                float rb3 = clamp((MASK_THRESHOLD_3 - roundedBox * MASK_MULTIPLIER_3) * MASK_STRENGTH_3, NUM_ZERO, NUM_ONE) -
                    clamp(pow(NUM_ONE - roundedBox * MASK_MULTIPLIER_3, NUM_ONE) * MASK_STRENGTH_3, NUM_ZERO, NUM_ONE);

                fragColor = vec4(NUM_ZERO);
                float transition = smoothstep(NUM_ZERO, NUM_ONE, rb1 + rb2);

                if (transition > NUM_ZERO) {
                    float lensAmount = max(NUM_ZERO, NUM_ONE - roundedBox * LENS_MULTIPLIER);
                    vec2 lens = ((uv - NUM_HALF) * lensAmount + NUM_HALF);
                    float total = NUM_ZERO;
                    for (float x = -SAMPLE_RANGE; x <= SAMPLE_RANGE; x++) {
                        for (float y = -SAMPLE_RANGE; y <= SAMPLE_RANGE; y++) {
                            vec2 offset = vec2(x, y) * SAMPLE_OFFSET / iResolution.xy;
                            fragColor += texture2D(iChannel0, offset + lens);
                            total += NUM_ONE;
                        }
                    }
                    fragColor /= total;

                    float gradient = clamp((clamp(m2.y, NUM_ZERO, GRADIENT_RANGE) + GRADIENT_OFFSET) / NUM_TWO, NUM_ZERO, NUM_ONE) +
                        clamp((clamp(-m2.y, GRADIENT_EXTREME, GRADIENT_RANGE) * rb3 + GRADIENT_OFFSET) / NUM_TWO, NUM_ZERO, NUM_ONE);
                    vec4 lighting = clamp(fragColor + vec4(rb1) * gradient + vec4(rb2) * LIGHTING_INTENSITY, NUM_ZERO, NUM_ONE);

                    fragColor = mix(texture2D(iChannel0, uv), lighting, transition);
                } else {
                    fragColor = texture2D(iChannel0, uv);
                }
            }

            void main() {
                mainImage(gl_FragColor, gl_FragCoord.xy);
            }
        </script>
    
    <main>

            <div class="notification flyout col-content-wrapper liquid-glass" style="left: 82%; top: 15%;">
                <div class="liquid-glass--bend"></div>
                <div class="liquid-glass--face"></div>
                <div class="liquid-glass--edge"></div>
                <h2>Notification LOL</h2>
                <p>asdfasdgdgh  sdgf</p>
            </div>

            <div class="music flyout col-content-wrapper liquid-glass" style="left: 82%; top: 15%;">
                <div class="liquid-glass--bend"></div>
                <div class="liquid-glass--face"></div>
                <div class="liquid-glass--edge"></div>

                <div style="background-color: rgba(50, 50, 50, 0.7); padding: 1rem; border-radius: 0.5rem;font-weight: 100;">
                    <p style="color: rgb(180, 180, 180);" id="lastSong"></p>
                    <h2 style="margin-top: 0.01rem; margin-bottom: 0.1rem; color:white;">Now Playing</h2>
                    <p style="color:white;" id="currentSong"></p>
                    <p style="color: rgb(180, 180, 180);" id="nextSong"></p>
                </div>
                <img id="cdImage" class="cd-spinning" src="images/cd.png" style="width: 75%; height: 50%; margin-bottom: 1rem; margin: auto;top: 1rem;" alt="Album Art">
                <div class="music-player-controls" style="margin: auto;top: 2rem;">
                  <button id="audioBack" title="Previous song" style="background: none; border: none; margin-right: 1rem;">
                    <img src="images/icons/music/music_player_back.png" alt="Music Player - Back Button">
                  </button>

                  <button id="audioPlayPause" title="Play / Pause" style="background: none; border: none; width: 2.5rem; height: 2.5rem; margin-right: 1rem;">
                    <img src="images/icons/music/music_player_play.png" id="audioPlayPauseImage" alt="Music Player - Play / Pause Button">
                  </button>

                  <button id="audioForward" title="Next song" style="background: none; border: none;">
                    <img src="images/icons/music/music_player_forward.png" alt="Music Player - Forward Button">
                  </button>
                </div>
            </div>

        <section class="intro">
            <div class="intro-visualiser" aria-hidden="true">
                <canvas id="introVisualiserCanvas"></canvas>
            </div>
            <div class="intro-top-right" style="color: #F86BC7; position: absolute; top: 2rem; right: 0; width: 50%; height: 50%; display: flex; flex-direction: column; align-items: flex-end; justify-content: flex-start; padding: 2rem; box-sizing: border-box;">
                <div class="window-wrapper no-padding" style="opacity: 1; z-index: 1; top: 2rem; right: 2rem; min-width: 360px;">
                    <div class="window colored glass">
                        <div class="title-bar dbl-maximize">
                            <div class="title-bar-text">SAKURA - Archived Utopia</div>
                            <div class="title-bar-controls">
                                <button aria-label="Minimize" class="minimize"></button>
                                <button aria-label="Maximize" class="maximize"></button>
                                <button aria-label="Close" class="close"></button>
                            </div>
                        </div>
                        <div class="window-body">
                            <div class="notepad-container" contenteditable=""><pre>
                                <h1>Not Just A Base</h1>
                                <p>This is a fully automated, eco-integrated logistics hub</p>
                            </pre>
                            </div>
                        </div>
                    </div>
                </div>                
            </div>
            <div class="intro-bottom-left" style="color: #4577ea; position: absolute; top: 50%; left: 0; width: 50%; height: 50%; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-end; padding: 2rem; box-sizing: border-box;">
                <div class="window-wrapper no-padding" style="opacity: 1; z-index: 1; top: 100rem; left: 354px; min-width: 360px;">
                    <div class="window colored glass">
                        <div class="title-bar dbl-maximize">
                            <div class="title-bar-text">SAKURA - Archived Utopia</div>
                            <div class="title-bar-controls">
                                <button aria-label="Minimize" class="minimize"></button>
                                <button aria-label="Maximize" class="maximize"></button>
                                <button aria-label="Close" class="close"></button>
                            </div>
                        </div>
                        <div class="window-body">
                            <div class="notepad-container" contenteditable=""><pre>
                                <h1>Eco-friendly</h1>
                                <p>A Sky Base that does not affect the Ground Ecosystem</p>
                            </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="position: relative; width: 100%; height: 300px;"></div>
            <!-- taskbar backdrop lives inside .intro so we can emulate backdrop-filter when
                 the taskbar becomes fixed. JS will size/position this element. -->
            <div class="taskbar-blur-backdrop" aria-hidden="true"></div>
        </section>

    <!-- Start menu and taskbar (embedded from example). Placed after .intro so the
         taskbar appears at the bottom of the intro as a normal element and becomes
         sticky when it reaches the top of the viewport. -->
    <div class="start-menu" id="spotlight-menu">
        <div class="colored glass window">
            <div class="title-bar">
                <div class="custom spotlight-container window-body">
                    <div id="spotlight-results"></div>
                    <input type="text" id="spotlight-input" placeholder="Type here to search...">
                </div>
            </div>
        </div>
    </div>
    <div class="start-menu" id="start-menu">
        <div class="colored glass window">
            <div class="title-bar">
                <div class="custom window-body">
                    <div class="pet">
                        <img src="images/icons/pcIcon.png" alt="pet">
                        <div role="tooltip">
                            <p>Welcome to the site.</p>
                        </div>
                    </div>
                </div>
                <div class="custom menu-sidebar">
                    <div class="top">
                        <button>
                            <a href="mailto:desk-feedback@glitchy.website?subject=Bug%20Report">Report a Bug </a>
                        </button>
                        <button>
                            <a href="mailto:desk-feedback@glitchy.website?subject=Feature%20Request">Request a Feature </a>
                        </button>
                    </div>
                    <div class="bottom">
                        <button id="shutdown">Shut down</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="colored glass taskbar-container window" style="visibility: hidden;">
        <div class="title-bar" style="padding: 0;">
            <div class="start-button">
                <img id="start-button" src="images/icons/startregular.png" alt="start">
            </div>
            <div id="taskbar" class="taskbar-btns">
                <div class="taskbar-btn active" style="width: auto; ">
                    <div class="taskbar-item icon-text" style="padding-left: 0.5rem; padding-right: 0.5rem;">
                        <img class="icon" src="images/icons/home.png" alt="Home" style="min-width: 2.2rem; min-height: 2.2rem;">
                        <p class="taskbar-label">Welcome Home!</p>
                    </div>
                </div>
                <div class="taskbar-btn" style="width: auto;">
                    <div class="taskbar-item icon-text" style="padding-left: 0.5rem; padding-right: 0.5rem;">
                        <img class="icon" src="images/icons/download.png" alt="Home" style="min-width: 2.2rem; min-height: 2.2rem;">
                        <p class="taskbar-label">Download</p>
                    </div>
                </div>
                <div class="taskbar-btn" style="width: auto;">
                    <div class="taskbar-item icon-text" style="padding-left: 0.5rem; padding-right: 0.5rem;">
                        <img class="icon" src="images/icons/book.png" alt="Home" style="min-width: 2.1rem; min-height: 2.1rem;">
                        <p class="taskbar-label">How to use / build?</p>
                    </div>
                </div>
                <div class="taskbar-btn" style="width: auto;">
                    <div class="taskbar-item icon-text" style="padding-left: 0.5rem; padding-right: 0.5rem;">
                        <img class="icon" src="images/icons/stats.png" alt="Home" style="min-width: 2.1rem; min-height: 2.1rem;">
                        <p class="taskbar-label">Stats & Progress</p>
                    </div>
                </div>
            </div>


            <div class="taskbar-icons">
                <img src="images/icons/tray/0.png" alt="icon1" class="small-icon sounds" id="volumeIcon">
                <img src="images/icons/music.webp" alt="icon4" class="small-icon music">
                <img src="images/icons/tray/notification.png" alt="icon1" class="small-icon notification">
            </div>

            <div class="clock" id="clock"style="margin-left: 0px;"></div>
            
        </div>
    </div>

    <section class="sticky-cols">
        <div class="sticky-cols-wrapper">
            <!-- Background video placed here so it sits behind the sticky cards
                 and only bleeds a bit into the intro/outro sections. -->
            <div class="bg-key-wrap" aria-hidden="true">
                <video class="bg-key" src="videos/theKey.mp4" muted autoplay loop playsinline preload="auto"></video>
            </div>
            <div class="col col-1">
                <div class="col-content">
                    <div class="col-content-wrapper liquid-glass">
                        <div class="liquid-glass--bend"></div>
                        <div class="liquid-glass--face"></div>
                        <div class="liquid-glass--edge"></div>
                        <h2>Closed-loop & Fully Automated</h2>
                        <p>Every resource in this base is produced, processed, and redistributed without manual input. Raw materials flow from farms to smelters to storage, feeding crafting, expansion, and trade in a seamless cycle. Nothing is decorative automation. Every system is integrated, scalable, and designed to run indefinitely without intervention.</p>
                    </div>
                </div>
            </div>
            <div class="col col-2">
                <div class="col-img col-img-1">
                    <div class="col-img-wrapper">
                        <img src="images/storage.png" alt="">
                    </div>
                </div>
                <div class="col-img col-img-2">
                    <div class="col-img-wrapper">
                        <img src="/images/hsrStation.png" alt="">
                    </div>
                </div>
            </div>
            <div class="col col-3">
                <div class="col-content-wrapper liquid-glass">
                    <div class="liquid-glass--bend"></div>
                    <div class="liquid-glass--face"></div>
                    <div class="liquid-glass--edge"></div>
                    <h2>Interconnected Transportation hub</h2>
                    <p>This base functions as a regional nexus where local metro lines, regional rail, and high-speed routes converge. It isn’t just a stop, it’s infrastructure. Movement between distant builds is intentional, efficient, and centralized, turning separate projects into a unified network.</p>
                </div>
                <div class="col-content-wrapper-2 liquid-glass">
                    <div class="liquid-glass--bend"></div>
                    <div class="liquid-glass--face"></div>
                    <div class="liquid-glass--edge"></div>
                    <h2>No visible farms. No exposed redstone. Pure Vibes</h2>
                    <p>Efficiency is hidden beneath architecture. Farms operate out of sight, redstone remains fully integrated into the structure, and automation never compromises atmosphere. Water features, greenery, and polished materials define the space. Performance and aesthetics coexisting without visible machinery.</p>
                </div>
            </div>
            <div class="col col-4">
                <div class="col-img">
                    <div class="col-img-wrapper">
                        <img src="images/autoSmelter.png">
                    </div>
                </div>                
            </div>
        </div>
    </section>

    <section class="outro">
        <h2>Thank you for visiting!</h2>
        <p>We hope you found what you were looking for.</p>

        <div class="social-links" style="background-color: 	#c3829e; color: #ffffff; position: absolute; bottom: 0; left: 0; right: 0; width: 100%; padding-top: 0.8rem;">
            <div id="OS logo" style="margin-left: 1.5rem; margin-top: 0.4rem;display: flex; flex-direction: column; align-items: center;">
                <p style="margin: 0 0 0.25rem 0; font-family: 'Segoe UI Light';">Compatible with</p>
                <img src="images/windows7.png" alt="Windows 7 Compatible" style="width: 9rem;">
            </div>
            <div id="credit" style="font-family: 'Frutiger'; margin-left: 1.8rem; margin-top: 0.5rem;display: flex; flex-direction: row; flex-wrap: wrap; max-width: calc(100% - 14rem);">
                <h4 style="width: 100%;">CommonWorld  F U T U R E  Project 000 ~ Codename `Sakura Archive`</h4>
                <p>dge5: Original Vision, Architect</p> 
                <p>happygrassblock: Architect, Contiuned Development, Website Design</p>
                <p>wslsp713: Site Discovery</p>
                <p>52013145129: Site Discovery</p>
                <p>m1chelin_man: Site Discovery</p>
                <p>mynameisnt_gary: Site Discovery, Resource Gathering</p>
                <p>honami.1: Site Discovery, Naming</p>
                <p>thedrexy: Resource Gathering</p>
                <p>infiniteenergyresource: Resource Gathering</p>
                <p>rainbay: Resource Gathering</p>

                <p style="margin-top: 0.8rem;">Special thanks to [PLACEHOLDER] for redstone builds used in the base design, [PLACEHOLDER] for the music used in the site.</p>
                <p style="width: 100%;"> and to Virtual Self- Key for the animated background</p>

                <p style="width: 100%; margin-top: 0.8rem;">Current OS: Horizon OS 1.0</p>
                <p style="font-size: 0.8rem;">オープン価格商品の問い合わせください。</p>
                <p style="text-align: right; width: 100%; margin-top: -0.8rem; margin-bottom: 0.8rem; font-family: 'Segoe UI Light';">さくらアーカイブ 2011 © All rights reserved.</p>
            </div>
        </div>

    </section>
</main>


<!--
Compatible with (Windows 7 image logo)

CommonWorld  F U T U R E  Project 000 ~ Codename `Sakura Archive`
dge5: Original Vision, Architect
happygrassblock: Architect, Contiuned Development
wslsp713, 52013145129, m1chelin_man: site discovery
mynameisnt_gary: site discovery, resource gathering
honami.1: site discovery, Naming
thedrexy, infiniteenergyresource, rainbay: resource gathering

Special thanks to [
PLACEHOLDER
] for redstone builds used in the base design, and to [
PLACEHOLDER
] for the music used in the site.

OS: Horizon OS 1.0
オープン価格商品の問い合わせください。

さくらアーカイブ 2011 © All rights reserved.
-->


    <!-- SVG Filter for Liquid Glass Effect -->
    <svg style="display: none" xmlns="http://www.w3.org/2000/svg">
        <filter id="glass-blur" x="0" y="0" width="100%" height="100%" filterUnits="objectBoundingBox">
            <feTurbulence type="fractalNoise" baseFrequency="0.003 0.007" numOctaves="1" result="turbulence" />
            <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="200" xChannelSelector="R" yChannelSelector="G" />
        </filter>
    </svg>

    <script src="taskbar-backdrop-embed.js"></script>
    <script src="home.js"></script>
    
    <script>
        // Global audio state for music controls
        const musicBasePath = 'sounds/songs/';
        let bgMusic = null;
        let playlist = [];
        let currentIndex = 0;
        const volumeLevels = [0, 0.1, 0.2, 0.35, 0.5];
        let volumeLevelIndex = 3;
        const volumeStorageKey = 'musicVolumeLevelIndex';
        let introVisualizerContext = null;
        let introVisualizerAnalyser = null;
        let introVisualizerSource = null;
        let introVisualizerData = null;
        let introVisualizerConnectedAudio = null;

        const getSongLabel = (filename) => {
            if (!filename) return '';
            return filename.replace(/\.[^/.]+$/, '');
        };

        const initIntroVisualizer = () => {
            const canvas = document.getElementById('introVisualiserCanvas');
            const section = document.querySelector('.intro-visualiser');
            if (!canvas || !section) return;

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            const resizeCanvas = () => {
                const ratio = window.devicePixelRatio || 1;
                const width = Math.max(1, section.clientWidth);
                const height = Math.max(1, section.clientHeight);
                canvas.width = Math.floor(width * ratio);
                canvas.height = Math.floor(height * ratio);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.scale(ratio, ratio);
            };

            const setupAnalyser = () => {
                if (!bgMusic || introVisualizerConnectedAudio === bgMusic) return;

                if (!introVisualizerContext) {
                    const AudioContextCtor = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContextCtor) return;
                    introVisualizerContext = new AudioContextCtor();
                }

                introVisualizerAnalyser = introVisualizerContext.createAnalyser();
                introVisualizerAnalyser.fftSize = 1024;
                introVisualizerSource = introVisualizerContext.createMediaElementSource(bgMusic);
                introVisualizerSource.connect(introVisualizerAnalyser);
                introVisualizerAnalyser.connect(introVisualizerContext.destination);
                introVisualizerData = new Uint8Array(introVisualizerAnalyser.frequencyBinCount);
                introVisualizerConnectedAudio = bgMusic;
            };

            const draw = () => {
                requestAnimationFrame(draw);

                const width = section.clientWidth;
                const height = section.clientHeight;
                ctx.clearRect(0, 0, width, height);

                setupAnalyser();
                if (!introVisualizerAnalyser || !introVisualizerData) return;

                if (introVisualizerContext && introVisualizerContext.state === 'suspended') {
                    introVisualizerContext.resume().catch(() => {});
                }

                introVisualizerAnalyser.getByteFrequencyData(introVisualizerData);

                const bufferLength = introVisualizerData.length;
                const barGap = 3;
                const targetBarWidth = 4.5;
                const barCount = Math.max(1, Math.floor((width + barGap) / (targetBarWidth + barGap)) * 2);
                const barWidth = Math.max((width - (barCount - 1) * barGap) / barCount, 3);
                const sampleStep = bufferLength / barCount;
                let x = 0;

                for (let index = 0; index < barCount; index++) {
                    const sampleIndex = Math.min(bufferLength - 1, Math.floor(index * sampleStep));
                    const barHeight = (introVisualizerData[sampleIndex] / 255) * height;
                    ctx.fillStyle = 'rgba(248, 107, 199, 0.88)';
                    ctx.fillRect(x, height - barHeight, barWidth, barHeight);
                    x += barWidth + barGap;
                }
            };

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas, { passive: true });
            draw();
        };

        const updateSongLabels = () => {
            if (!playlist.length) return;
            const lastIndex = (currentIndex - 1 + playlist.length) % playlist.length;
            const nextIndex = (currentIndex + 1) % playlist.length;

            const lastEl = document.getElementById('lastSong');
            const currentEl = document.getElementById('currentSong');
            const nextEl = document.getElementById('nextSong');

            if (lastEl) lastEl.textContent = getSongLabel(playlist[lastIndex]);
            if (currentEl) currentEl.textContent = getSongLabel(playlist[currentIndex]);
            if (nextEl) nextEl.textContent = getSongLabel(playlist[nextIndex]);
        };

        const loadStoredVolume = () => {
            const stored = Number.parseInt(localStorage.getItem(volumeStorageKey), 10);
            if (!Number.isNaN(stored) && stored >= 0 && stored < volumeLevels.length) {
                volumeLevelIndex = stored;
            }
        };

        const persistVolume = () => {
            localStorage.setItem(volumeStorageKey, String(volumeLevelIndex));
        };

        const updateVolumeIcon = () => {
            const volumeIcon = document.getElementById('volumeIcon');
            if (volumeIcon) {
                volumeIcon.src = `images/icons/tray/${volumeLevelIndex}.png`;
            }
        };

        const applyVolume = () => {
            if (!bgMusic) return;
            bgMusic.volume = volumeLevels[volumeLevelIndex];
        };

        const ensureAudio = () => {
            if (bgMusic) return;
            bgMusic = new Audio();
            applyVolume();
            bgMusic.loop = false;
            bgMusic.addEventListener('ended', () => {
                playNext(true);
            });
        };

        const setPlayingState = (isPlaying) => {
            const playPauseImage = document.getElementById('audioPlayPauseImage');
            const cdImage = document.getElementById('cdImage');
            if (playPauseImage) {
                playPauseImage.src = isPlaying
                    ? 'images/icons/music/music_player_pause.png'
                    : 'images/icons/music/music_player_play.png';
            }
            if (cdImage) {
                if (isPlaying) {
                    cdImage.classList.add('playing');
                } else {
                    cdImage.classList.remove('playing');
                }
            }
        };

        const loadTrack = (index, autoplay) => {
            if (!playlist.length) return;
            ensureAudio();
            currentIndex = (index + playlist.length) % playlist.length;
            bgMusic.src = `${musicBasePath}${playlist[currentIndex]}`;
            updateSongLabels();
            if (autoplay) {
                bgMusic.play()
                    .then(() => setPlayingState(true))
                    .catch(err => console.log('Background music play failed:', err));
            } else {
                setPlayingState(false);
            }
        };

        const playNext = (autoplay = true) => {
            if (!playlist.length) return;
            loadTrack(currentIndex + 1, autoplay);
        };

        const playPrev = (autoplay = true) => {
            if (!playlist.length) return;
            loadTrack(currentIndex - 1, autoplay);
        };

        const loadPlaylist = async () => {
            try {
                const response = await fetch(`${musicBasePath}playlist.json`, { cache: 'no-store' });
                if (!response.ok) throw new Error(`Playlist load failed: ${response.status}`);
                const data = await response.json();
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Playlist is empty or invalid.');
                }
                playlist = data;
            } catch (err) {
                console.log('Playlist load failed:', err);
                playlist = [];
            }
        };

        // Scroll-lock helpers — lock page scroll while the welcome runs (prevents wheel/touch/keyboard)
        let _welcomeScrollLock = { locked: false, y: 0 };
        function _preventScrollDefault(e) { e.preventDefault(); }
        function _keydownScrollHandler(e) {
            const keys = [' ', 'PageUp', 'PageDown', 'End', 'Home', 'ArrowUp', 'ArrowDown'];
            if (keys.includes(e.key) || [32,33,34,35,36,38,40].includes(e.keyCode)) {
                e.preventDefault();
            }
        }
        function disableScroll() {
            if (_welcomeScrollLock.locked) return;
            _welcomeScrollLock.locked = true;
            _welcomeScrollLock.y = window.scrollY || document.documentElement.scrollTop || 0;
            document.documentElement.style.scrollBehavior = 'auto';
            document.body.style.position = 'fixed';
            document.body.style.top = `-${_welcomeScrollLock.y}px`;
            document.body.style.left = '0';
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
            window.addEventListener('wheel', _preventScrollDefault, { passive: false });
            window.addEventListener('touchmove', _preventScrollDefault, { passive: false });
            document.addEventListener('keydown', _keydownScrollHandler, { passive: false });
        }
        function enableScroll() {
            if (!_welcomeScrollLock.locked) return;
            _welcomeScrollLock.locked = false;
            window.removeEventListener('wheel', _preventScrollDefault);
            window.removeEventListener('touchmove', _preventScrollDefault);
            document.removeEventListener('keydown', _keydownScrollHandler);
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
            const y = _welcomeScrollLock.y || 0;
            window.scrollTo(0, y);
            document.documentElement.style.scrollBehavior = '';
        }

        // Welcome splash screen logic
        window.addEventListener('load', function() {
            const welcomeSplash = document.getElementById('welcome-splash');
            const welcomeProgressBar = document.getElementById('welcome-progressbar');
            const welcomeAudio = new Audio('sounds/welcome.mp3');
            const taskbar = document.querySelector('.taskbar-container');

            loadStoredVolume();

            // Set audio volume to be quieter
            welcomeAudio.volume = 0.3;

            // Prevent scrolling during welcome screen and hide scrollbar
            disableScroll();

            // Hide taskbar during welcome
            if (taskbar) {
                taskbar.style.visibility = 'hidden';
            }

            // Play the welcome sound
            welcomeAudio.play().catch(err => console.log('Audio play failed:', err));

            // When audio finishes, scroll to top and hide splash
            welcomeAudio.addEventListener('ended', function() {
                // Immediately hide the glass inner image
                if (window._dismissGlassImage) window._dismissGlassImage();

                // Fade out the splash screen
                welcomeSplash.style.transition = 'opacity 0.5s ease-out';
                welcomeSplash.style.opacity = '0';
                if (welcomeProgressBar) {
                    welcomeProgressBar.style.transition = 'opacity 0.5s ease-out';
                    welcomeProgressBar.style.opacity = '0';
                }

                setTimeout(async function() {
                    welcomeSplash.style.display = 'none';
                    if (welcomeProgressBar) {
                        welcomeProgressBar.style.display = 'none';
                    }
                    // Re-enable scrolling
                    enableScroll();
                    // Ensure we're at the top
                    window.scrollTo(0, 0);
                    // Show taskbar after scrolling to top
                    if (taskbar) {
                        taskbar.style.visibility = 'visible';
                    }

                    // Play background music after welcome finishes
                    await loadPlaylist();
                    if (playlist.length) {
                        loadTrack(0, true);
                    }
                    updateVolumeIcon();
                    setTimeout(function() {
                        if (window.triggerMusicFlyoutIntro) {
                            window.triggerMusicFlyoutIntro();
                        }
                    }, 2000);
                }, 500);
            });
        });

        // Play/Pause and skip button functionality
        document.addEventListener('DOMContentLoaded', function() {
            initIntroVisualizer();

            const playPauseButton = document.getElementById('audioPlayPause');
            const backButton = document.getElementById('audioBack');
            const forwardButton = document.getElementById('audioForward');
            const volumeIcon = document.getElementById('volumeIcon');

            if (playPauseButton) {
                playPauseButton.addEventListener('click', function() {
                    if (!bgMusic) return;

                    if (bgMusic.paused) {
                        bgMusic.play()
                            .then(() => setPlayingState(true))
                            .catch(err => console.log('Play failed:', err));
                    } else {
                        bgMusic.pause();
                        setPlayingState(false);
                    }
                });
            }

            if (backButton) {
                backButton.addEventListener('click', function() {
                    playPrev(true);
                });
            }

            if (forwardButton) {
                forwardButton.addEventListener('click', function() {
                    playNext(true);
                });
            }

            if (volumeIcon) {
                updateVolumeIcon();
                volumeIcon.addEventListener('click', function() {
                    volumeLevelIndex = (volumeLevelIndex + 1) % volumeLevels.length;
                    applyVolume();
                    updateVolumeIcon();
                    persistVolume();
                });
            }
        });
    </script>
</body>
</html>